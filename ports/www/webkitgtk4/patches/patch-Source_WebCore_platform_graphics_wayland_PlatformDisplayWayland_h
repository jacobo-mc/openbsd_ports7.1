From 72fad08f2bfe7d2744c3217fe0ec0afcc671c53e Mon Sep 17 00:00:00 2001
From: Carlos Garcia Campos <carlosgc@webkit.org>
Date: Fri, 1 Apr 2022 09:00:32 +0000
Subject: [PATCH] REGRESSION(r290360): [GLX] Crash on process exit https://bugs.webkit.org/show_bug.cgi?id=238494

Index: Source/WebCore/platform/graphics/wayland/PlatformDisplayWayland.h
--- Source/WebCore/platform/graphics/wayland/PlatformDisplayWayland.h.orig
+++ Source/WebCore/platform/graphics/wayland/PlatformDisplayWayland.h
@@ -23,8 +23,7 @@
  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-#ifndef  PlatformDisplayWayland_h
-#define  PlatformDisplayWayland_h
+#pragma once
 
 #if PLATFORM(WAYLAND)
 
@@ -37,7 +36,9 @@ namespace WebCore {
 class PlatformDisplayWayland : public PlatformDisplay {
 public:
     static std::unique_ptr<PlatformDisplay> create();
-    static std::unique_ptr<PlatformDisplay> create(struct wl_display*);
+#if PLATFORM(GTK)
+    static std::unique_ptr<PlatformDisplay> create(GdkDisplay*);
+#endif
 
     virtual ~PlatformDisplayWayland();
 
@@ -51,8 +52,13 @@ class PlatformDisplayWayland : public PlatformDisplay 
     Type type() const final { return PlatformDisplay::Type::Wayland; }
 
 protected:
-    PlatformDisplayWayland(struct wl_display*, NativeDisplayOwned);
+    explicit PlatformDisplayWayland(struct wl_display*);
+#if PLATFORM(GTK)
+    explicit PlatformDisplayWayland(GdkDisplay*);
 
+    void sharedDisplayDidClose() override;
+#endif
+
     void initialize();
 
     virtual void registryGlobal(const char* interface, uint32_t name);
@@ -67,5 +73,3 @@ class PlatformDisplayWayland : public PlatformDisplay 
 SPECIALIZE_TYPE_TRAITS_PLATFORM_DISPLAY(PlatformDisplayWayland, Wayland)
 
 #endif // PLATFORM(WAYLAND)
-
-#endif // PlatformDisplayWayland_h
