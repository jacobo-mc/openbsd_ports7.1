From 72fad08f2bfe7d2744c3217fe0ec0afcc671c53e Mon Sep 17 00:00:00 2001
From: Carlos Garcia Campos <carlosgc@webkit.org>
Date: Fri, 1 Apr 2022 09:00:32 +0000
Subject: [PATCH] REGRESSION(r290360): [GLX] Crash on process exit https://bugs.webkit.org/show_bug.cgi?id=238494

Index: Source/WebCore/platform/graphics/PlatformDisplay.h
--- Source/WebCore/platform/graphics/PlatformDisplay.h.orig
+++ Source/WebCore/platform/graphics/PlatformDisplay.h
@@ -33,6 +33,12 @@
 typedef void *EGLDisplay;
 #endif
 
+#if PLATFORM(GTK)
+#include <wtf/glib/GRefPtr.h>
+
+typedef struct _GdkDisplay GdkDisplay;
+#endif
+
 #if ENABLE(VIDEO) && USE(GSTREAMER_GL)
 #include "GRefPtrGStreamer.h"
 
@@ -74,6 +80,7 @@ class PlatformDisplay { (public)
 
 #if USE(EGL) || USE(GLX)
     WEBCORE_EXPORT GLContext* sharingGLContext();
+    void clearSharingGLContext();
 #endif
 
 #if USE(EGL)
@@ -96,12 +103,18 @@ class PlatformDisplay { (public)
 #endif
 
 protected:
-    enum class NativeDisplayOwned { No, Yes };
-    explicit PlatformDisplay(NativeDisplayOwned);
+    PlatformDisplay();
+#if PLATFORM(GTK)
+    explicit PlatformDisplay(GdkDisplay*);
+#endif
 
     static void setSharedDisplayForCompositing(PlatformDisplay&);
 
-    NativeDisplayOwned m_nativeDisplayOwned { NativeDisplayOwned::No };
+#if PLATFORM(GTK)
+    virtual void sharedDisplayDidClose();
+
+    GRefPtr<GdkDisplay> m_sharedDisplay;
+#endif
 
 #if USE(EGL)
     virtual void initializeEGLDisplay();
